# Sticky Sessions or session affinity

What if after the initial session is established, you want to keep sending requests to the same server? It is very annoying to get suddenly logged out and lost your session state, and need to start again!

By default, an ELB routes each request independently to a registered target based on the chosen load-balancing algorithm. However, you can use sticky sessions to enable the load balancer to bind a user’s session to a specific target.

For example, apps that cache their session information locally on the webserver.

Examples of this:

* A shopping cart
* An online form
* A training website
* Chat conversations
* Blue/Green deployments

A general guide can be found [here](https://docs.aws.amazon.com/prescriptive-guidance/latest/load-balancer-stickiness/options.html)


## What are sticky sessions or session affinity?

They override the load balancing algorithm. Uses a session cookie that identifies that session belongs to the same user. All traffic is sent to the server that holds the session data. To use them, the client must support cookies.


## Supported modes for cookies

Application Load Balancers support both duration-based cookies and application-based cookies. Sticky sessions are enabled at the target group level. You can use a combination of both, or non at all in your target groups.


## Key usage

You must first understand how long your load balancer should consistently route the user’s request to the same target.

* If your app has its own session cookie, then you can use application-based stickiness and the load balancer session cookie follows the duration specified by the app session cookie.

* If the app does not have its own session cookie, then you can use duration-based stickiness to generate a cookie with a duration that you specify.


Security of the duration based cookies generated by the ELB

The contents of the cookies are encrypted using a rotating key. You can’t decrypt or modify load-balancer-generated cookies.


## Considerations

* ALBs do not support cookie values that are URL encoded

* ALB use the EXPIRES attribute in the cookie header instead of the Max-Age

* Web-Sockets are inherently sticky. If you try to use one, you’ll get a 101 response status.

* If you have multiple layers of ALBs, you can enable sticky sessions across all  layers with app-based cookies. However, with duration based-cookies, you can enable sticky sessions only on one layer.

* For app-based cookies, cookie names have to be specified individually for each target group.

* For duration-based cookies, cookie names will be named AWSALB and that’s going to  be used across all target groups.

# The labs

Inside this section, you'll find two labs, each implementing each of this cookies for you to see and play around on what exactly does it mean for an app to support session based cookies, and how exactly does each one of this behave.
